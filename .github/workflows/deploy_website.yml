name: Deploy Static Website

on:
    push:
        branches: master

permissions:
    id-token: write
    contents: read

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v4.1.0

            - name: Install dependencies
              run: npm ci

            - name: Build the app
              run: npm build

    deploy: 
        needs: build

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4.0.2
          with:
            aws-region: ap-northeast-1
            role-to-assume: ${{ secrets.AWS_ROLE }}
        
        - name: Print role
          run: aws sts get-caller-identity

        - name: Sync to S3
          run: |
            aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET_NAME }} --delete --acl public-read
            echo "This job's status is ${{ job.status }}."

        - name: Invalidate CloudFront Cache
          run: |
            aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"